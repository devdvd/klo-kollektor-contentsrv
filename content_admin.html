<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klo-Kollektor Content Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #2c3e50;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .edition-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .edition-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .edition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .edition-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .locations-list {
            margin-top: 15px;
        }

        .location-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f1f5f9;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .json-editor {
            height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöΩ Klo-Kollektor Content Admin</h1>
            <p>Verwaltung von Editionen und Content-Packs</p>
        </div>

        <div class="main-content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">üìä √úbersicht</button>
                <button class="tab" onclick="switchTab('upload')">üì§ Upload</button>
                <button class="tab" onclick="switchTab('manage')">‚öôÔ∏è Verwalten</button>
                <button class="tab" onclick="switchTab('test')">üß™ Test</button>
            </div>

            <!-- √úbersicht Tab -->
            <div id="overview" class="tab-content active">
                <h2>üìä Server-Statistiken</h2>
                <div class="stats-grid" id="statsGrid">
                    <!-- Wird von JavaScript gef√ºllt -->
                </div>

                <h2>üì¶ Aktuelle Editionen</h2>
                <div class="edition-list" id="editionsList">
                    <!-- Wird von JavaScript gef√ºllt -->
                </div>
            </div>

            <!-- Upload Tab -->
            <div id="upload" class="tab-content">
                <h2>üì§ Neue Edition hochladen</h2>
                
                <div class="card">
                    <h3>Schnell-Upload (aus Content-Datei)</h3>
                    <form id="quickUploadForm">
                        <div class="form-group">
                            <label>Content-Pack ausw√§hlen:</label>
                            <select id="packSelect" required>
                                <option value="">-- Bitte w√§hlen --</option>
                                <option value="seasonal">Saison-Paket</option>
                                <option value="premium_sports">Sport Premium</option>
                                <option value="emergency">Notfall-Paket</option>
                                <option value="transport">Transport-Paket</option>
                                <option value="extreme">Extrem-Paket</option>
                                <option value="retro">Retro-Paket</option>
                                <option value="weird">Verr√ºcktes Zeug</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Edition ausw√§hlen:</label>
                            <select id="editionSelect" required>
                                <option value="">-- Erst Pack w√§hlen --</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary">üì§ Edition hochladen</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Manueller Upload (JSON)</h3>
                    <form id="manualUploadForm">
                        <div class="form-group">
                            <label>Pack ID:</label>
                            <input type="text" id="manualPackId" placeholder="z.B. seasonal" required>
                        </div>

                        <div class="form-group">
                            <label>Edition ID:</label>
                            <input type="text" id="manualEditionId" placeholder="z.B. winter_special" required>
                        </div>

                        <div class="form-group">
                            <label>JSON-Daten:</label>
                            <textarea id="manualJsonData" class="json-editor" placeholder='{"id": "winter_special", "name": {...}, ...}' required></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">üì§ Manuell hochladen</button>
                        <button type="button" class="btn btn-secondary" onclick="validateJson()">‚úÖ JSON validieren</button>
                    </form>
                </div>

                <div id="uploadMessages"></div>
            </div>

            <!-- Verwalten Tab -->
            <div id="manage" class="tab-content">
                <h2>‚öôÔ∏è Content-Verwaltung</h2>
                
                <div class="card">
                    <h3>Server-Aktionen</h3>
                    <button class="btn btn-primary" onclick="refreshContent()">üîÑ Content neu laden</button>
                    <button class="btn btn-success" onclick="deployNewVersion()">üöÄ Neue Version deployen</button>
                    <button class="btn btn-danger" onclick="clearCache()">üóëÔ∏è Cache leeren</button>
                </div>

                <div class="card">
                    <h3>Backup & Export</h3>
                    <button class="btn btn-primary" onclick="exportAllContent()">üíæ Alles exportieren</button>
                    <button class="btn btn-secondary" onclick="createBackup()">üìã Backup erstellen</button>
                </div>

                <div id="manageMessages"></div>
            </div>

            <!-- Test Tab -->
            <div id="test" class="tab-content">
                <h2>üß™ Content-Tests</h2>
                
                <div class="card">
                    <h3>API-Tests</h3>
                    <button class="btn btn-primary" onclick="testHealthCheck()">‚ù§Ô∏è Health Check</button>
                    <button class="btn btn-primary" onclick="testUpdateCheck()">üîÑ Update Check</button>
                    <button class="btn btn-primary" onclick="testDownloadSpeed()">‚ö° Download-Speed</button>
                </div>

                <div class="card">
                    <h3>Content-Validierung</h3>
                    <button class="btn btn-success" onclick="validateAllContent()">‚úÖ Alle Editionen pr√ºfen</button>
                    <button class="btn btn-secondary" onclick="checkUnlockConditions()">üîì Freischalt-Bedingungen testen</button>
                </div>

                <div id="testResults"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';

        // Tab-Switching
        function switchTab(tabName) {
            // Alle Tabs deaktivieren
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Aktiven Tab aktivieren
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Content laden
            if (tabName === 'overview') {
                loadOverview();
            }
        }

        // Content-Daten (aus deiner Datei)
        const allContentPacks = {
            "seasonal": {
                "winter_special": {
                    "id": "winter_special",
                    "name": {"de": "Winter-Special", "en": "Winter Special"},
                    "color": "#74b9ff",
                    "icon": "‚ùÑÔ∏è",
                    "type": "seasonal",
                    "difficulty": 2,
                    "locations": [
                        {"id": "christmasmarket", "name": {"de": "Weihnachtsmarkt"}, "flag": "üéÑ"},
                        {"id": "skiresort", "name": {"de": "Skigebiet"}, "flag": "‚õ∑Ô∏è"},
                        {"id": "icerink", "name": {"de": "Eislaufbahn"}, "flag": "‚õ∏Ô∏è"},
                        {"id": "sledding", "name": {"de": "Schlittenbahn"}, "flag": "üõ∑"}
                    ]
                },
                "summer_festivals": {
                    "id": "summer_festivals",
                    "name": {"de": "Sommer-Festivals", "en": "Summer Festivals"},
                    "color": "#fdcb6e",
                    "icon": "üé™",
                    "locations": [
                        {"id": "rockamring", "name": {"de": "Rock am Ring"}, "flag": "üé∏"},
                        {"id": "wacken", "name": {"de": "Wacken"}, "flag": "ü§ò"},
                        {"id": "oktoberfest", "name": {"de": "Oktoberfest"}, "flag": "üç∫"}
                    ]
                }
            },
            "emergency": {
                "fastfood": {
                    "id": "fastfood",
                    "name": {"de": "Fast Food Rettung"},
                    "color": "#ff6b6b",
                    "icon": "üçî",
                    "locations": [
                        {"id": "mcdonalds", "name": {"de": "McDonald's"}, "flag": "üçü"},
                        {"id": "burgerking", "name": {"de": "Burger King"}, "flag": "üëë"},
                        {"id": "kfc", "name": {"de": "KFC"}, "flag": "üçó"}
                    ]
                }
            }
        };

        // Pack-Select Change Handler
        document.getElementById('packSelect').addEventListener('change', function() {
            const packId = this.value;
            const editionSelect = document.getElementById('editionSelect');
            
            editionSelect.innerHTML = '<option value="">-- Edition w√§hlen --</option>';
            
            if (packId && allContentPacks[packId]) {
                for (const [editionId, edition] of Object.entries(allContentPacks[packId])) {
                    const option = document.createElement('option');
                    option.value = editionId;
                    option.textContent = `${edition.icon} ${edition.name.de || edition.name}`;
                    editionSelect.appendChild(option);
                }
            }
        });

        // Quick Upload Form
        document.getElementById('quickUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const packId = document.getElementById('packSelect').value;
            const editionId = document.getElementById('editionSelect').value;
            
            if (!packId || !editionId) {
                showMessage('uploadMessages', 'Bitte Pack und Edition ausw√§hlen!', 'error');
                return;
            }

            const editionData = allContentPacks[packId][editionId];
            
            try {
                const response = await fetch(`${API_BASE}/content/upload`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        packId,
                        editionId,
                        data: editionData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('uploadMessages', `‚úÖ Edition "${editionData.name.de}" erfolgreich hochgeladen!`, 'success');
                    document.getElementById('quickUploadForm').reset();
                } else {
                    showMessage('uploadMessages', `‚ùå Fehler: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('uploadMessages', `‚ùå Verbindungsfehler: ${error.message}`, 'error');
            }
        });

        // Manual Upload Form
        document.getElementById('manualUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const packId = document.getElementById('manualPackId').value;
            const editionId = document.getElementById('manualEditionId').value;
            const jsonData = document.getElementById('manualJsonData').value;
            
            try {
                const data = JSON.parse(jsonData);
                
                const response = await fetch(`${API_BASE}/content/upload`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ packId, editionId, data })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('uploadMessages', `‚úÖ Edition "${editionId}" erfolgreich hochgeladen!`, 'success');
                    document.getElementById('manualUploadForm').reset();
                } else {
                    showMessage('uploadMessages', `‚ùå Fehler: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('uploadMessages', `‚ùå JSON-Fehler: ${error.message}`, 'error');
            }
        });

        // Overview laden
        async function loadOverview() {
            try {
                // Statistiken laden
                const statsResponse = await fetch(`${API_BASE}/content/stats`);
                const stats = await statsResponse.json();
                
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalPacks}</div>
                        <div>Content-Packs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalEditions}</div>
                        <div>Editionen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${formatBytes(stats.totalSize)}</div>
                        <div>Gesamtgr√∂√üe</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">‚úÖ</div>
                        <div>Server Status</div>
                    </div>
                `;

                // Beispiel-Editionen anzeigen
                displaySampleEditions();

            } catch (error) {
                console.error('Overview-Fehler:', error);
            }
        }

        function displaySampleEditions() {
            const editionsList = document.getElementById('editionsList');
            let html = '';

            for (const [packId, pack] of Object.entries(allContentPacks)) {
                for (const [editionId, edition] of Object.entries(pack)) {
                    html += `
                        <div class="edition-card">
                            <div class="edition-header">
                                <div>
                                    <span class="edition-icon">${edition.icon}</span>
                                    <strong>${edition.name.de || edition.name}</strong>
                                </div>
                                <span style="background: ${edition.color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                    ${packId}
                                </span>
                            </div>
                            <div>Schwierigkeit: ${'‚≠ê'.repeat(edition.difficulty || 1)}</div>
                            <div class="locations-list">
                                <strong>Orte (${edition.locations?.length || 0}):</strong>
                                ${(edition.locations || []).slice(0, 3).map(loc => 
                                    `<div class="location-item">
                                        <span>${loc.flag} ${loc.name.de || loc.name}</span>
                                    </div>`
                                ).join('')}
                                ${edition.locations?.length > 3 ? `<div style="text-align: center; color: #666; padding: 5px;">... und ${edition.locations.length - 3} weitere</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }

            editionsList.innerHTML = html;
        }

        // Hilfsfunktionen
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            const className = type === 'error' ? 'error-message' : 'success-message';
            container.innerHTML = `<div class="${className}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function validateJson() {
            const jsonData = document.getElementById('manualJsonData').value;
            try {
                JSON.parse(jsonData);
                showMessage('uploadMessages', '‚úÖ JSON ist g√ºltig!', 'success');
            } catch (error) {
                showMessage('uploadMessages', `‚ùå JSON-Fehler: ${error.message}`, 'error');
            }
        }

        // Test-Funktionen
        async function testHealthCheck() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const result = await response.json();
                showMessage('testResults', `‚úÖ Server l√§uft! Uptime: ${Math.round(result.uptime)}s`, 'success');
            } catch (error) {
                showMessage('testResults', `‚ùå Server nicht erreichbar: ${error.message}`, 'error');
            }
        }

        async function testUpdateCheck() {
            try {
                const response = await fetch(`${API_BASE}/content/check-updates`);
                const result = await response.json();
                showMessage('testResults', `‚úÖ Update-Check OK! Version: ${result.version}`, 'success');
            } catch (error) {
                showMessage('testResults', `‚ùå Update-Check fehlgeschlagen: ${error.message}`, 'error');
            }
        }

        // Management-Funktionen
        function refreshContent() {
            showMessage('manageMessages', 'üîÑ Content wird neu geladen...', 'success');
            loadOverview();
        }

        function deployNewVersion() {
            showMessage('manageMessages', 'üöÄ Neue Version wird deployed...', 'success');
        }

        function clearCache() {
            showMessage('manageMessages', 'üóëÔ∏è Cache wurde geleert!', 'success');
        }

        function exportAllContent() {
            const dataStr = JSON.stringify(allContentPacks, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'klo-kollektor-content-export.json';
            link.click();
            URL.revokeObjectURL(url);
            showMessage('manageMessages', 'üíæ Content exportiert!', 'success');
        }

        // Beim Laden die √úbersicht anzeigen
        document.addEventListener('DOMContentLoaded', loadOverview);
    </script>
</body>
</html>